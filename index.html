<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Stok Opname Harian</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Tailwind + extend brand colors -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              light: '#A4D4A4',   /* hijau muda */
              DEFAULT: '#1F3D1F', /* hijau tua */
              dark: '#10200F'     /* aksen gelap */
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-green-50 text-gray-700 font-sans p-6">
  <h2 class="text-3xl font-bold text-center text-brand mb-8">STOK OPNAME HARIAN</h2>

  <div class="flex flex-wrap gap-4 justify-center mb-6">
    <div class="flex flex-col flex-1 min-w-[200px]">
      <label for="file-resep" class="font-semibold mb-1 text-brand-dark">RESEP:</label>
      <input type="file" id="file-resep" accept=".xls,.xlsx"
             class="p-2 border border-brand rounded-lg focus:ring-2 focus:ring-brand-light">
      <span id="status-resep" class="mt-1 text-sm text-gray-500">Belum di-load</span>
    </div>
    <div class="flex flex-col flex-1 min-w-[200px]">
      <label for="file-sales" class="font-semibold mb-1 text-brand-dark">PENJUALAN:</label>
      <input type="file" id="file-sales" accept=".xls,.xlsx"
             class="p-2 border border-brand rounded-lg focus:ring-2 focus:ring-brand-light">
      <span id="status-sales" class="mt-1 text-sm text-gray-500">Belum di-load</span>
    </div>
    <button id="btn-hitung"
            class="inline-block px-4 py-3 text-base bg-brand text-white rounded-lg shadow hover:bg-brand-dark transition disabled:opacity-50"
            disabled>
      Hitung
    </button>
  </div>

  <div class="grid gap-6 md:grid-cols-2">
    <div class="bg-white shadow-lg rounded-lg p-6 border-l-4 border-brand">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-brand">üìä Ringkasan Penjualan</h3>
        <button id="copy-sales-btn"
                class="px-3 py-1 bg-brand-light text-brand-dark rounded hover:bg-green-200 transition">
          Salin
        </button>
      </div>
      <div class="flex flex-wrap gap-2 mb-4">
        <select id="filter-sales"
                class="p-2 border border-brand rounded-lg focus:ring-2 focus:ring-brand-light">
          <option>All</option>
        </select>
      </div>
      <div class="overflow-auto">
        <table id="table-sales" class="min-w-full divide-y divide-gray-200 hidden">
          <thead class="bg-brand text-white">
            <tr>
              <th class="px-4 py-2 text-left">Menu/Produk</th>
              <th class="px-4 py-2 text-left">Kategori</th>
              <th class="px-4 py-2 text-left">Qty Terjual</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>

    <div class="bg-white shadow-lg rounded-lg p-6 border-l-4 border-brand">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-brand">üìù Kebutuhan Bahan</h3>
        <button id="copy-bahan-btn"
                class="px-3 py-1 bg-brand-light text-brand-dark rounded hover:bg-green-200 transition">
          Salin
        </button>
      </div>
      <div class="flex flex-wrap gap-2 mb-4">
        <select id="filter-bahan"
                class="p-2 border border-brand rounded-lg focus:ring-2 focus:ring-brand-light">
          <option>All</option>
        </select>
      </div>
      <div class="overflow-auto">
        <table id="table-bahan" class="min-w-full divide-y divide-gray-200 hidden">
          <thead class="bg-brand text-white">
            <tr>
              <th class="px-4 py-2 text-left">Bahan</th>
              <th class="px-4 py-2 text-left">Kategori</th>
              <th class="px-4 py-2 text-left">Jumlah</th>
              <th class="px-4 py-2 text-left">Satuan</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // Normalisasi kategori: gabungkan minuman panas/dingin jadi 'Minuman', makan ringan/berat jadi 'Makanan'
    function normalizeCategory(cat) {
      const c = cat.toLowerCase();
      if (c.includes('minuman')) return 'MINUMAN';
      if (c.includes('makanan')) return 'MAKANAN';
      return cat || 'Uncategorized';
    }

    let resepData = [];
    let salesDataMap = {};
    let originalSalesData = [];
    let currentSalesData = [];
    let originalBahanData = [];
    let currentBahanData = [];

    function readExcel(file, cb) {
      const reader = new FileReader();
      reader.onload = e => {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        cb(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' }));
      };
      reader.readAsBinaryString(file);
    }
    document.getElementById('file-resep').addEventListener('change', e => { if (e.target.files[0]) readExcel(e.target.files[0], parseResep); });
    document.getElementById('file-sales').addEventListener('change', e => { if (e.target.files[0]) readExcel(e.target.files[0], parseSales); });

    function parseResep(raw) {
      const norm = v => v.toString().trim().replace(',', '.');
      resepData = raw.map(r => {
        const row = {};
        Object.entries(r).forEach(([k,v]) => {
          const key = k.trim().toLowerCase();
          if (key === 'menu') row.Menu = norm(v);
          if (key === 'bahan') row.Bahan = norm(v).toUpperCase();
          if (key === 'jumlah') row.Jumlah = parseFloat(norm(v)) || 0;
          if (key === 'satuan') row.Satuan = v.toString().trim();
          if (key === 'yieldqty') row.YieldQty = parseFloat(norm(v)) || 1;
        });
        return row;
      }).filter(r => r.Menu && r.Bahan);
      document.getElementById('status-resep').textContent = `Resep: ${resepData.length} baris`;
      checkReady();
    }

    function parseSales(raw) {
      salesDataMap = {};
      raw.forEach(r => {
        let produk = '', qty = 0, kategori = '';
        Object.entries(r).forEach(([k,v]) => {
          const key = k.trim().toLowerCase();
          if (['menu','produk'].includes(key)) produk = v;
          if (['jumlah','qty','terjual','jumlah terjual'].includes(key)) qty = parseFloat(v) || 0;
          if (key === 'kategori') kategori = normalizeCategory(v);
        });
        if (produk) {
          if (!salesDataMap[produk]) salesDataMap[produk] = { qty: 0, category: kategori };
          salesDataMap[produk].qty += qty;
        }
      });
      document.getElementById('status-sales').textContent = `Penjualan: ${Object.keys(salesDataMap).length} produk`;
      checkReady();
    }

    function checkReady() {
      document.getElementById('btn-hitung').disabled = !(resepData.length && Object.keys(salesDataMap).length);
    }

    document.getElementById('btn-hitung').addEventListener('click', () => {
      // Sales: build & sort
      originalSalesData = Object.entries(salesDataMap).map(([m,d]) => ({ produk: m, qty: d.qty, category: d.category || 'Uncategorized' }));
      originalSalesData.sort((a,b) => a.produk.localeCompare(b.produk));
      currentSalesData = [...originalSalesData];
      setupSalesFilter();
      renderSales();

      // Bahan: compute needs with normalized categories
      const map = {}, units = {}, bahanCategories = {};
      const intermediate = new Set(resepData.map(r=>r.Menu));
      Object.entries(salesDataMap).forEach(([menu,d]) => {
        const qty = d.qty;
        const cat = d.category;
        const recs = resepData.filter(r=>r.Menu===menu);
        if (!recs.length) return;
        const ratio = qty / recs[0].YieldQty;
        recs.forEach(r => {
          const need = r.Jumlah * ratio;
          const keyBahan = r.Bahan;
          if (!bahanCategories[keyBahan]) bahanCategories[keyBahan] = new Set();
          bahanCategories[keyBahan].add(cat);
          if (intermediate.has(keyBahan)) {
            resepData.filter(s=>s.Menu===keyBahan).forEach(s => {
              const subNeed = s.Jumlah * (need / s.YieldQty);
              map[s.Bahan] = (map[s.Bahan]||0) + subNeed;
              units[s.Bahan] = s.Satuan;
              if (!bahanCategories[s.Bahan]) bahanCategories[s.Bahan] = new Set();
              bahanCategories[s.Bahan].add(cat);
            });
          } else {
            map[keyBahan] = (map[keyBahan]||0) + need;
            units[keyBahan] = r.Satuan;
          }
        });
      });
      originalBahanData = Object.entries(map).map(([b,v]) => ({
        bahan: b,
        jumlah: v,
        satuan: units[b]||'',
        category: Array.from(bahanCategories[b]||['Uncategorized']).join(', ')
      }));
      originalBahanData.sort((a,b) => a.bahan.localeCompare(b.bahan));
      currentBahanData = [...originalBahanData];
      setupBahanFilter();
      renderBahan();
    });

    function setupSalesFilter() {
      const sel = document.getElementById('filter-sales'); sel.innerHTML = '';
      sel.append(new Option('All','All'));
      [...new Set(originalSalesData.map(i=>i.category))].forEach(c => sel.append(new Option(c,c)));
    }
    function setupBahanFilter() {
      const sel = document.getElementById('filter-bahan'); sel.innerHTML = '';
      sel.append(new Option('All','All'));
      [...new Set(originalBahanData.map(i=>i.category))].forEach(c => sel.append(new Option(c,c)));
    }

    function renderSales() {
      const tb = document.querySelector('#table-sales tbody'); tb.innerHTML = '';
      const fmt = new Intl.NumberFormat('id-ID',{minimumFractionDigits:2,maximumFractionDigits:2});
      currentSalesData.forEach(({produk,qty,category}) => tb.insertAdjacentHTML('beforeend', `<tr><td class="px-4 py-2">${produk}</td><td class="px-4 py-2">${category}</td><td class="px-4 py-2">${fmt.format(qty)}</td></tr>`));
      document.getElementById('table-sales').classList.remove('hidden');
    }
    function renderBahan() {
      const tb = document.querySelector('#table-bahan tbody'); tb.innerHTML = '';
      const fmt = new Intl.NumberFormat('id-ID',{minimumFractionDigits:2,maximumFractionDigits:2});
      currentBahanData.forEach(({bahan,jumlah,satuan,category}) => tb.insertAdjacentHTML('beforeend', `<tr><td class="px-4 py-2">${bahan}</td><td ÌÅ¥ÎûòÏä§="px-4 py-2">${category}</td><td class="px-4 py-2">${fmt.format(jumlah)}</td><td class="px-4 py-2">${satuan}</td></tr>`));
      document.getElementById('table-bahan').classList.remove('hidden');
    }

    document.getElementById('filter-sales').addEventListener('change', () => {
      const v=document.getElementById('filter-sales').value;
      currentSalesData = v==='All' ? [...originalSalesData] : originalSalesData.filter(i=>i.category===v);
      renderSales();
    });
    document.getElementById('filter-bahan').addEventListener('change', () => {
      const v=document.getElementById('filter-bahan').value;
      currentBahanData = v==='All' ? [...originalBahanData] : originalBahanData.filter(i=>i.category===v);
      renderBahan();
    });

    function copyTable(id) {
      const rows = Array.from(document.querySelectorAll(`#${id} tbody tr`)).map(r=>Array.from(r.cells).map(c=>c.textContent).join('\t')).join('\n');
      navigator.clipboard.writeText(rows);
    }
    document.getElementById('copy-sales-btn').addEventListener('click', () => copyTable('table-sales'));
    document.getElementById('copy-bahan-btn').addEventListener('click', () => copyTable('table-bahan'));
  </script>
</body>
</html>
